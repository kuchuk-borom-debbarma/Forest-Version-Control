# üîó Linking a Repository to a Tree Storage

A standalone FVC repository can become part of a Tree only after it is linked to a Tree Storage.
Linking moves the repository from local-storage mode to shared-storage mode, enabling hierarchical relationships and
centralized snapshot management.

---

## üü© Command

```bash
fvc link-storage \
  --storage "/absolute/path/to/tree_storage" \
  --path "logical/tree/path/when/reconstructing"
```

### Parameters

| Flag        | Description                                                                                            |
|-------------|--------------------------------------------------------------------------------------------------------|
| `--storage` | Absolute filesystem path to the Tree Storage root                                                      |
| `--path`    | Logical tree path representing where this repository should appear when the full tree is reconstructed |

This command does not establish hierarchy; it only links the repository to the storage.

---

# üìå Steps Performed During Linking

## 1. Create a Link File Inside the Repository

A JSON link file is created in:

```
repo/.fvc/link.json
```

Example:

```json
{
  "repoID": "uuid-93fa0e2a",
  "repoName": "HospitalService",
  "storagePath": "/abs/path/to/HospitalManagementStorage",
  "desiredTreeLocation": "services/HospitalService",
  "linkedAt": "2025-03-01T14:55:22Z",
  "version": 1
}
```

This file provides all information the repository needs to communicate with the Tree Storage and ensures that
repository-side operations always know where the central store is located.

---

## 2. Transfer Local Objects to the Tree Storage

All objects from:

```
repo/.fvc/objects/
```

are transferred into:

```
tree_storage/.fvc/objects/
```

The transfer process includes:

* content hash verification
* deduplication based on hash
* atomic copying
* safe rollback if the operation is interrupted

Once transfer completes successfully, the repository no longer retains a local objects directory.

---

## 3. Create a Repository Directory Inside Tree Storage

Tree Storage maintains a dedicated directory for every linked repository:

```
tree_storage/.fvc/repositories/<repoID>/
```

This directory contains the canonical representation of the repository inside the Tree.

The following files are created:

### `metadata.bin`

A binary-encoded metadata file describing:

* repository name
* author
* description
* creation timestamp
* linking timestamp

### `HEAD`

Stores the current commit hash:

```
<commitHash or null>
```

### `repoName.txt`

Human-readable repository name:

```
HospitalService
```

### `relativePath.txt`

Logical path used when reconstructing the Tree:

```
services/HospitalService
```

### `workspace_path.txt`

Absolute path to the repository‚Äôs working directory:

```
/Users/admin/code/HospitalService
```

This path allows Tree Storage to locate the repository workspace during operations such as:

* commits
* hierarchy operations
* super-snap operations

Tree Storage thus becomes fully aware of both its logical tree location and its physical workspace path.

---

## 4. Remove Local Object Storage

After the transfer and metadata creation are complete, the local directory:

```
repo/.fvc/objects/
```

is removed.

This ensures there is only one authoritative object store: the Tree Storage.

The repository becomes a ‚Äúthin workspace‚Äù that delegates all version-control storage operations to the central store.

---

# ‚≠ê Summary

Linking a repository to a Tree Storage performs the following actions:

1. Creates `.fvc/link.json` inside the repository
2. Performs a full object transfer to the Tree Storage
3. Creates a metadata directory for the repository under `repositories/<repoID>/`
4. Records the repository‚Äôs logical tree path
5. Records the repository‚Äôs physical workspace path
6. Removes the local objects directory to prevent storage duplication

Once linked, the repository becomes part of a shared, unified version-control environment and can participate in
hierarchical Trees and Tree Snapshots.
